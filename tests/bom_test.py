import pandas as pd
import pandas.testing as pdt
import numpy as np
from bom import combine_bom_components, sort_bom, modify_bom_fields

def test_combine_bom_components():
    # Tests the combine_bom_components function with sample BOM
    input_data = {
        'Designator': [
            'C1', 'C2', 'C3', 'C4', 'C5', 'C6', 'C8', 'C9', 'C10', 'C11', 'C12', 
            'C13', 'C14', 'C16', 'C18', 'C20', 'C21', 'C22', 'C23', 'C24', 'C25', 
            'VD8', 'VD9', 'VD10', 'VD11', 'VD12', 'VD13', 'VD14', 'VD15', 'VD16', 
            'VD17', 'VD18', 'VD19', 'VD20', 'VD21', 'VD22', 'VD23', 'VD24', 'VD25', 
            'VD26', 'VD27', 'VD28', 'VD29', 'VD30', 'VD31', 'VD32', 'VD33', 'VD34', 
            'VD35', 'VD36', 'VD37', 'VD38', 'VD39', 'VD40', 'VD41', 'VD42', 'VD43', 
            'VD44', 'VD45'
        ],
        'Name': [
            'Конденсатор чип 0805 0,1 мкФ 50В X7R', 'Конденсатор чип 1210 4,7 мкФ 50В X7R', 
            'Конденсатор чип 1210 4,7 мкФ 50В X7R', 'Конденсатор чип 1210 4,7 мкФ 50В X7R', 
            'Конденсатор чип 0805 0,1 мкФ 50В X7R', 'Конденсатор чип 0805 220 пФ 50В X7R', 
            'Конденсатор чип 0805 220 пФ 50В X7R электр. пл...', 'Конденсатор чип 0805 220 пФ 50В X7R', 
            'Конденсатор танталовый D 10 мкФ 50В', 'Конденсатор танталовый D 10 мкФ 50В', 
            'Конденсатор чип 0805 0,1 мкФ 50В X7R электр. п...', 'Конденсатор чип 0805 0,1 мкФ 50В X7R электр. п...',
            'Конденсатор чип 0805 0,1 мкФ 50В X7R электр. п...', 'Конденсатор чип 0805 0,1 мкФ 50В X7R электр. п...', 
            'Конденсатор чип 0805 0,1 мкФ 50В X7R электр. п...', 'Конденсатор чип 0805 0,1 мкФ 50В X7R электр. п...', 
            'Конденсатор чип 0805 0,1 мкФ 50В X7R электр. п...', 'Конденсатор чип 0805 0,1 мкФ 50В X7R электр. п...', 
            'Конденсатор чип 2220 180 пФ 500В NP0', 'Конденсатор чип 1210 4,7 мкФ 50В X7R', 
            'Конденсатор чип 1210 4,7 мкФ 50В X7R', 'Диод MBRA160T3G', 'Диод MBRA160T3G', 
            'Диод GL34J', 'Диод GL34J', 'Стабилитрон BZV55B16 16 В 2%', 'Стабилитрон BZV55B16 16 В 2%', 
            'Диод GL34J', 'Светодиод зеленый LTST-108TGKT', 'Стабилитрон BZV55B16 16 В 2%', 
            'Диод LL4148', 'Диод LL4148', 'Диод LL4148', 'Стабилитрон BZV55B20 20 В 2%', 
            'Стабилитрон Z3SMC12 12 В 5%', 'Стабилитрон Z3SMC12 12 В 5%', 'Стабилитрон Z3SMC12 12 В 5%', 
            'Стабилитрон Z3SMC12 12 В 5%', 'Стабилитрон Z3SMC12 12 В 5%', 'Стабилитрон Z3SMC12 12 В 5%', 
            'Стабилитрон Z3SMC16 16 В 5%', 'Стабилитрон Z3SMC16 16 В 5%', 'Стабилитрон Z3SMC16 16 В 5%', 
            'Диод GL34J', 'Светодиод зеленый LTST-108TGKT', 'Стабилитрон BZV55B16 16 В 2%', 
            'Диод LL4148', 'Диод LL4148', 'Диод LL4148', 'Стабилитрон BZV55B20 20 В 2%', 
            'Стабилитрон Z3SMC12 12 В 5%', 'Стабилитрон Z3SMC12 12 В 5%', 'Стабилитрон Z3SMC12 12 В 5%', 
            'Стабилитрон Z3SMC12 12 В 5%', 'Стабилитрон Z3SMC12 12 В 5%', 'Стабилитрон Z3SMC12 12 В 5%', 
            'Стабилитрон Z3SMC16 16 В 5%', 'Стабилитрон Z3SMC16 16 В 5%', 'Стабилитрон Z3SMC16 16 В 5%'
        ],
        'Quantity': [1] * 59,
        'Decimal Number': [np.nan] * 59
    }    
    expected_data = {
        'Decimal Number': [pd.NA] * 15,
        'Name': [
            'Диод GL34J', 'Диод LL4148', 'Диод MBRA160T3G', 'Конденсатор танталовый D 10 мкФ 50В',
            'Конденсатор чип 0805 0,1 мкФ 50В X7R', 'Конденсатор чип 0805 0,1 мкФ 50В X7R электр. п...',
            'Конденсатор чип 0805 220 пФ 50В X7R', 'Конденсатор чип 0805 220 пФ 50В X7R электр. пл...',
            'Конденсатор чип 1210 4,7 мкФ 50В X7R', 'Конденсатор чип 2220 180 пФ 500В NP0',
            'Светодиод зеленый LTST-108TGKT', 'Стабилитрон BZV55B16 16 В 2%', 'Стабилитрон BZV55B20 20 В 2%',
            'Стабилитрон Z3SMC12 12 В 5%', 'Стабилитрон Z3SMC16 16 В 5%'
        ],
        'Quantity': [4, 6, 2, 2, 2, 8, 2, 1, 5, 1, 2, 4, 2, 12, 6],
        'Designator': [
            'VD10,VD11,VD14,VD30', 'VD17,VD18,VD19,VD33,VD34,VD35', 'VD8,VD9', 'C10,C11',
            'C1,C5', 'C12,C13,C14,C16,C18,C20,C21,C22', 'C6,C9', 'C8',
            'C2,C3,C4,C24,C25', 'C23', 'VD15,VD31', 'VD12,VD13,VD16,VD32',
            'VD20,VD36', 'VD21,VD22,VD23,VD24,VD25,VD26,VD37,VD38,VD39,VD40,VD41,VD42',
            'VD27,VD28,VD29,VD43,VD44,VD45'
        ]
    }
    input_df = pd.DataFrame(input_data)
    expected_df = pd.DataFrame(expected_data)

    actual_df = combine_bom_components(input_df)

    pdt.assert_frame_equal(actual_df, expected_df)

def test_sort_bom():
    # Tests the sort_bom function with sample BOM
    input_data = {
        "Decimal Number": [
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            "ОЛПА-31.014.01",
            "ОЛПА-41.001.46",
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            "ОЛПА-34.001.10"
        ],
        "Name": [
            "Диод GL34J",
            "Индуктивность LQM21NN4R7K10L 4,7 мкГн",
            "Колодка клеммная ME09R-500-02P gray, правая, серая",
            "Конденсатор танталовый D 10 мкФ 50В",
            "Конденсатор чип 0805 0,1 мкФ 50В X7R",
            "Микросхема CD4047BP",
            "Микросхема TL431BIDBZ",
            "Модуль МТ-01",
            "Плата печатная TBUS-ПП-01",
            "Предохранитель Littelfuse 0242.080 0,08 А",
            "Резистор чип 0805 1 кОм 1% 100 ppm/°C",
            "Стабилитрон Z3SMC12 12 В 5%",
            "Тиристор S6X8BBS",
            "Транзистор ZVN3306F",
            "Трансформатор ТРН-ER9.5-N87-01"
        ],
        "Quantity": [
            4,
            2,
            3,
            2,
            30,
            2,
            4,
            2,
            1,
            4,
            16,
            12,
            4,
            12,
            2
        ],
        "Designator": [
            "VD10,VD11,VD14,VD30",
            "L5,L8",
            "XP4,XP5,XP6",
            "C10,C11",
            "C1,C5,C12,C13,C14,C16,C18,C19,C20,C21,C24,C25,C28,C29,C32,C33,C41,C43,C44,C47,C49,C50,C60,C64,C66,C67,C70,C72,C73,C83",
            "DD1,DD2",
            "DA13,DA14,DA15,DA16",
            "M1,M3",
            "XP8",
            "F4,F5,F6,F7",
            "R2,R3,R51,R52,R54,R56,R57,R58,R59,R106,R107,R109,R111,R112,R113,R114",
            "VD21,VD22,VD23,VD24,VD25,VD26,VD37,VD38,VD39,VD40,VD41,VD42",
            "VS1,VS2,VS3,VS4",
            "VT9,VT10,VT11,VT12,VT13,VT14,VT23,VT24,VT25,VT26,VT27,VT28",
            "T1,T2"
        ]
    } 
    expected_data = {
        "Decimal Number": [
            np.nan,
            np.nan,
            "ОЛПА-31.014.01",
            "ОЛПА-41.001.46",
            "ОЛПА-34.001.10",
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan
        ],
        "Name": [
            np.nan,
            "Сборочные единицы",
            "Модуль МТ-01",
            "Плата печатная TBUS-ПП-01",
            "Трансформатор ТРН-ER9.5-N87-01",
            np.nan,
            "Вилки",
            "Колодка клеммная ME09R-500-02P gray, правая, серая",
            np.nan,
            "Диоды",
            "Диод GL34J",
            "Стабилитрон Z3SMC12 12 В 5%",
            np.nan,
            "Индуктивности",
            "Индуктивность LQM21NN4R7K10L 4,7 мкГн",
            np.nan,
            "Конденсаторы",
            "Конденсатор танталовый D 10 мкФ 50В",
            "Конденсатор чип 0805 0,1 мкФ 50В X7R",
            np.nan,
            "Микросхемы аналоговые",
            "Микросхема TL431BIDBZ",
            np.nan,
            "Микросхемы цифровые",
            "Микросхема CD4047BP",
            np.nan,
            "Предохранители",
            "Предохранитель Littelfuse 0242.080 0,08 А",
            np.nan,
            "Резисторы",
            "Резистор чип 0805 1 кОм 1% 100 ppm/°C",
            np.nan,
            "Тиристоры",
            "Тиристор S6X8BBS",
            np.nan,
            "Транзисторы",
            "Транзистор ZVN3306F"
        ],
        "Quantity": [
            np.nan,
            np.nan,
            2.0,
            1.0,
            2.0,
            np.nan,
            np.nan,
            3.0,
            np.nan,
            np.nan,
            4.0,
            12.0,
            np.nan,
            np.nan,
            2.0,
            np.nan,
            np.nan,
            2.0,
            30.0,
            np.nan,
            np.nan,
            4.0,
            np.nan,
            np.nan,
            2.0,
            np.nan,
            np.nan,
            4.0,
            np.nan,
            np.nan,
            16.0,
            np.nan,
            np.nan,
            4.0,
            np.nan,
            np.nan,
            12.0
        ],
        "Designator": [
            np.nan,
            np.nan,
            "M1,M3",
            "XP8",
            "T1,T2",
            np.nan,
            np.nan,
            "XP4...XP6",
            np.nan,
            np.nan,
            "VD10,VD11,VD14,VD30",
            "VD21...VD26,VD37...VD42",
            np.nan,
            np.nan,
            "L5,L8",
            np.nan,
            np.nan,
            "C10,C11",
            "C1,C5,C12...C14,C16,C18...C21,C24,C25,C28,C29,C32,C33,C41,C43,C44,C47,C49,C50,C60,C64,C66,C67,C70,C72,C73,C83",
            np.nan,
            np.nan,
            "DA13...DA16",
            np.nan,
            np.nan,
            "DD1,DD2",
            np.nan,
            np.nan,
            "F4...F7",
            np.nan,
            np.nan,
            "R2,R3,R51,R52,R54,R56...R59,R106,R107,R109,R111...R114",
            np.nan,
            np.nan,
            "VS1...VS4",
            np.nan,
            np.nan,
            "VT9...VT14,VT23...VT28"
        ]
    }

    groups_data = {
        'Key': ['C', 'DA', 'DD', 'F', 'L', 'M', 'R', 'T', 'VD', 'VDA', 'XP', 'VS', 'VT'],
        'Value': [
            'Конденсаторы', 'Микросхемы аналоговые', 'Микросхемы цифровые',
            'Предохранители', 'Индуктивности', 'Модули', 'Резисторы',
            'Трансформаторы', 'Диоды', 'Оптроны', 'Вилки', 'Тиристоры', 'Транзисторы'
        ]
    }

    input_df = pd.DataFrame(input_data)
    expected_df = pd.DataFrame(expected_data)
    groups_df = pd.DataFrame(groups_data)

    actual_df = sort_bom(input_df, groups_df)

    pdt.assert_frame_equal(actual_df, expected_df)

def test_modify_bom_fields():
    # Tests the sort_bom function with sample BOM
    input_data = {
        "Decimal Number": [
            np.nan,
            np.nan,
            "ОЛПА-31.014.01",
            "ОЛПА-41.001.46",
            "ОЛПА-34.001.10",
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan
        ],
        "Name": [
            np.nan,
            "Сборочные единицы",
            "Модуль МТ-01",
            "Плата печатная TBUS-ПП-01",
            "Трансформатор ТРН-ER9.5-N87-01",
            np.nan,
            "Вилки",
            "Колодка клеммная ME09R-500-02P gray, правая, серая",
            np.nan,
            "Диоды",
            "Диод GL34J",
            "Стабилитрон Z3SMC12 12 В 5%",
            np.nan,
            "Индуктивности",
            "Индуктивность LQM21NN4R7K10L 4,7 мкГн",
            np.nan,
            "Конденсаторы",
            "Конденсатор танталовый D 10 мкФ 50В",
            "Конденсатор чип 0805 0,1 мкФ 50В X7R",
            np.nan,
            "Микросхемы аналоговые",
            "Микросхема TL431BIDBZ",
            np.nan,
            "Микросхемы цифровые",
            "Микросхема CD4047BP",
            np.nan,
            "Предохранители",
            "Предохранитель Littelfuse 0242.080 0,08 А",
            np.nan,
            "Резисторы",
            "Резистор чип 0805 1 кОм 1% 100 ppm/°C",
            np.nan,
            "Тиристоры",
            "Тиристор S6X8BBS",
            np.nan,
            "Транзисторы",
            "Транзистор ZVN3306F"
        ],
        "Quantity": [
            np.nan,
            np.nan,
            2.0,
            1.0,
            2.0,
            np.nan,
            np.nan,
            3.0,
            np.nan,
            np.nan,
            4.0,
            12.0,
            np.nan,
            np.nan,
            2.0,
            np.nan,
            np.nan,
            2.0,
            30.0,
            np.nan,
            np.nan,
            4.0,
            np.nan,
            np.nan,
            2.0,
            np.nan,
            np.nan,
            4.0,
            np.nan,
            np.nan,
            16.0,
            np.nan,
            np.nan,
            4.0,
            np.nan,
            np.nan,
            12.0
        ],
        "Designator": [
            np.nan,
            np.nan,
            "M1,M3",
            "XP8",
            "T1,T2",
            np.nan,
            np.nan,
            "XP4...XP6",
            np.nan,
            np.nan,
            "VD10,VD11,VD14,VD30",
            "VD21...VD26,VD37...VD42",
            np.nan,
            np.nan,
            "L5,L8",
            np.nan,
            np.nan,
            "C10,C11",
            "C1,C5,C12...C14,C16,C18...C21,C24,C25,C28,C29,C32,C33,C41,C43,C44,C47,C49,C50,C60,C64,C66,C67,C70,C72,C73,C83",
            np.nan,
            np.nan,
            "DA13...DA16",
            np.nan,
            np.nan,
            "DD1,DD2",
            np.nan,
            np.nan,
            "F4...F7",
            np.nan,
            np.nan,
            "R2,R3,R51,R52,R54,R56...R59,R106,R107,R109,R111...R114",
            np.nan,
            np.nan,
            "VS1...VS4",
            np.nan,
            np.nan,
            "VT9...VT14,VT23...VT28"
        ]
    } 
    expected_data = {
        "Decimal Number": [
            '', '', 'ОЛПА-31.014.01', 'ОЛПА-41.001.46', 'ОЛПА-34.001.10', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
            '', '', ''
        ],
        "Name": [
            '', 'Сборочные единицы', 'Модуль МТ-01', 'Плата печатная TBUS-ПП-01',
            'Трансформатор ТРН-ER9.5-N87-01', '', 'Вилки', 'Колодка клеммная ME09R-500-02P',
            'gray, правая, серая', '', 'Диоды', 'Диод GL34J', '', 'Стабилитрон Z3SMC12 12 В 5%',
            '', '', 'Индуктивности', 'Индуктивность LQM21NN4R7K10L', '4,7 мкГн', '',
            'Конденсаторы', 'Конденсатор танталовый D 10 мкФ 50В', 'Конденсатор чип 0805 0,1 мкФ 50В',
            'X7R', '', '', '', '', '', '', '', '', '', '', 'Микросхемы аналоговые',
            'Микросхема TL431BIDBZ', '', 'Микросхемы цифровые', 'Микросхема CD4047BP',
            '', 'Предохранители', 'Предохранитель Littelfuse 0242.080', '0,08 А', '',
            'Резисторы', 'Резистор чип 0805 1 кОм 1%', '100 ppm/°C', '', '', '', '', '',
            'Тиристоры', 'Тиристор S6X8BBS', '', 'Транзисторы', 'Транзистор ZVN3306F', ''
        ],
        "Quantity": [
            '', '', 2.0, 1.0, 2.0, '', '', 3.0, '', '', '', 4.0, '', 12.0, '', '', '', 2.0,
            '', '', '', 2.0, 30.0, '', '', '', '', '', '', '', '', '', '', '', '', 4.0, '',
            '', 2.0, '', '', 4.0, '', '', '', 16.0, '', '', '', '', '', '', '', 4.0, '',
            '', 12.0, ''
        ],
        "Designator": [
            '', '', 'M1,M3', 'XP8', 'T1,T2', '', '', 'XP4...XP6', '', '', '', 'VD10,VD11,',
            'VD14,VD30', 'VD21...VD26,', 'VD37...VD42', '', '', 'L5,L8', '', '', '',
            'C10,C11', 'C1,C5,', 'C12...C14,', 'C16,', 'C18...C21,', 'C24,C25,C28,',
            'C29,C32,C33,', 'C41,C43,C44,', 'C47,C49,C50,', 'C60,C64,C66,',
            'C67,C70,C72,', 'C73,C83', '', '', 'DA13...DA16', '', '', 'DD1,DD2', '', '',
            'F4...F7', '', '', '', 'R2,R3,R51,', 'R52,R54,', 'R56...R59,', 'R106,R107,',
            'R109,', 'R111...R114', '', '', 'VS1...VS4', '', '', 'VT9...VT14,', 'VT23...VT28'
        ]
    }

    input_df = pd.DataFrame(input_data)
    expected_df = pd.DataFrame(expected_data)

    actual_df = modify_bom_fields(input_df)

    pdt.assert_frame_equal(actual_df, expected_df)